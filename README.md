# OSA_AP2061A 控制脚本说明

`OSA_AP2061A.py` 是一个用于通过 PyApex 库驱动 Apex Technologies AP2061A 光谱分析仪的便捷脚本。脚本封装了 PyApex 暴露的底层 SCPI 指令，提供了可靠的连续采集循环，并可选地实时绘制光谱。

---

## 功能亮点
- **PyApex 集成**：建立到仪器的 TCP/IP 连接，自动完成波长、跨度和通道等基础配置。
- **持续采集**：测量在后台线程中运行，即使前端界面刷新或阻塞，也不会中断数据采集。
- **峰值摘要**：每次扫频后输出时间戳与峰值信息，便于快速掌握信号变化。
- **实时绘图（可选）**：基于 matplotlib 绘制光谱图，刷新周期可配置。
- **优雅退出**：对连接异常、线程异常及 `Ctrl+C` 中断进行处理，确保资源释放。

---

## 环境依赖
- Python 3.8 及以上
- PyApex 库（需事先安装并在 `PYTHONPATH` 中可见）
- 可选依赖：`matplotlib`（启用 `--plot` 时才需要）

若需绘图功能，可先安装 matplotlib：

```bash
pip install matplotlib
```

---

## 命令行用法
```bash
python OSA_AP2061A.py [选项]
```

| 选项 | 默认值 | 说明 |
| ---- | ------ | ---- |
| `--ip` | `192.168.99.198` | 仪器 IP 地址 |
| `--port` | `5900` | 仪器控制端口 |
| `--channel` | `1` | 极化通道（如 `1`、`2`、`1&2` 等） |
| `--center` | `1550.0` | 中心波长，单位 nm |
| `--span` | `0.250` | 扫描跨度，单位 nm |
| `--interval` | `0.5` | 连续两次扫频之间的延时（秒） |
| `--mode` | `single` | 扫描模式：`single`、`repeat`、`auto` |
| `--scale-x` | `nm` | X 轴单位：`nm` 或 `GHz` |
| `--scale-y` | `log` | Y 轴单位：`log` → dBm，`lin` → mW |
| `--trace` | `1` | 读取的谱线编号（1-6） |
| `--summary-only` | *(关闭)* | 仅打印峰值摘要，不输出数据长度信息 |
| `--simulation` | *(关闭)* | 启用 PyApex 仿真模式（无需真实硬件） |
| `--plot` | *(关闭)* | 启用实时绘图（需要 matplotlib） |
| `--plot-refresh-ms` | `100.0` | 绘图刷新周期，毫秒 |

示例：开启实时绘图，并放慢刷新以减轻 UI 负担：

```bash
python OSA_AP2061A.py --plot --plot-refresh-ms 250
```

---

## 工作流程简介
1. **连接与配置**：脚本实例化 `PyApex.AP2XXX`，获取仪器 ID，并设置中心波长、跨度和测量通道。
2. **后台采集线程**：独立线程循环调用 `OSA.Run()` 与 `OSA.GetData()`，并将结果推入线程安全队列。
3. **主线程处理**：从队列中取出结果，打印峰值信息，并在需要时更新 matplotlib 绘图。由于采集在后台进行，主线程可以专心处理 UI。
4. **关闭流程**：收到 Ctrl+C 或窗口关闭信号时，通知工作线程停止，等待其退出，再关闭 PyApex 连接。

---

## 常见问题
- **连接失败**：请核对仪器 IP 与端口设置，确保网络可达；可使用 PyApex 自带的终端工具先行验证。
- **拖动绘图窗口时暂停刷新**：在 Windows 上，默认 GUI 后端在拖动窗口时会暂停事件循环。采集线程仍在运行，松开鼠标后会集中刷新。如果需要拖动时也保持刷新，可考虑改用 Qt 后端或独立的绘图进程。
- **找不到 PyApex 模块**：确认 PyApex 已安装并位于 Python 搜索路径中（可直接运行 `pip install .` 或向 `PYTHONPATH` 添加 PyApex 目录）。

---

## 后续拓展思路
- 若需要更顺畅的交互，可将绘图部分替换为 PyQtGraph 或其他异步友好型 GUI 库。
- 在后台线程中增加数据持久化、特征提取或实时告警逻辑，实现自动化测试。
- 将脚本改造成模块化接口，在更大的自动化平台或测试框架中复用。
